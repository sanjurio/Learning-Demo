{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Document Analysis Chatbot</h1>
    
    {% if not api_key_configured %}
    <div class="alert alert-warning mb-4">
        <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>API Key Not Configured</h5>
        <p>The OpenAI API key is not configured yet. This feature requires an API key to work properly.</p>
        {% if current_user.is_admin %}
        <hr>
        <p class="mb-0">As an administrator, you can <a href="{{ url_for('admin_api_keys') }}" class="alert-link">configure the API key here</a>.</p>
        {% else %}
        <p class="mb-0">Please contact an administrator to configure the API key.</p>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-md-5 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Upload Document</h5>
                    <p class="text-muted">Upload a document (PDF, DOCX, or TXT) to analyze its content.</p>
                    
                    <form id="document-upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="document-file" class="form-label">Select Document</label>
                            <input class="form-control" type="file" id="document-file" name="file" accept=".pdf,.docx,.txt">
                            <div class="form-text">Supported formats: PDF, DOCX, TXT</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="analyze-btn" {% if not api_key_configured %}disabled{% endif %}>
                            <span id="analyze-btn-text">Analyze Document</span>
                            <span id="analyze-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-7">
            <div class="card shadow-sm">
                <div class="card-body" id="analysis-container">
                    <h5 class="card-title mb-3">Document Analysis</h5>
                    <p class="text-center text-muted" id="initial-message">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        Upload a document to see its analysis here.
                    </p>
                    
                    <!-- Analysis results will be displayed here -->
                    <div id="analysis-results" class="d-none">
                        <h6>Summary</h6>
                        <div class="p-3 mb-3 border rounded bg-light" id="summary-text"></div>
                        
                        <h6>Questions & Answers</h6>
                        <div id="qa-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="error-message">
                    An error occurred while analyzing the document.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadForm = document.getElementById('document-upload-form');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analyzeBtnText = document.getElementById('analyze-btn-text');
        const analyzeSpinner = document.getElementById('analyze-spinner');
        const initialMessage = document.getElementById('initial-message');
        const analysisResults = document.getElementById('analysis-results');
        const summaryText = document.getElementById('summary-text');
        const qaContainer = document.getElementById('qa-container');
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        const errorMessage = document.getElementById('error-message');
        
        uploadForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('document-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Please select a document to analyze.');
                return;
            }
            
            // Check file extension
            const fileName = file.name;
            const fileExt = fileName.split('.').pop().toLowerCase();
            
            if (!['pdf', 'docx', 'txt'].includes(fileExt)) {
                showError('Unsupported file format. Please upload a PDF, DOCX, or TXT file.');
                return;
            }
            
            // Show loading state
            setLoading(true);
            
            // Create form data for upload
            const formData = new FormData();
            formData.append('file', file);
            
            // Send the request
            fetch('/api/analyze-document', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                setLoading(false);
                
                if (!data.success) {
                    showError(data.message || 'Failed to analyze the document. Please try again.');
                    return;
                }
                
                // Display results
                displayResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                setLoading(false);
                showError('An error occurred during document analysis. Please try again later.');
            });
        });
        
        function setLoading(isLoading) {
            if (isLoading) {
                analyzeBtn.disabled = true;
                analyzeBtnText.textContent = 'Analyzing...';
                analyzeSpinner.classList.remove('d-none');
            } else {
                analyzeBtn.disabled = false;
                analyzeBtnText.textContent = 'Analyze Document';
                analyzeSpinner.classList.add('d-none');
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorModal.show();
        }
        
        function displayResults(data) {
            // Show results container
            initialMessage.classList.add('d-none');
            analysisResults.classList.remove('d-none');
            
            // Display summary
            summaryText.textContent = data.summary;
            
            // Display questions and answers
            qaContainer.innerHTML = '';
            
            if (data.ai_analysis) {
                // AI generated Q&A
                qaContainer.innerHTML = `<div class="alert alert-info mb-3">
                    <small class="text-muted d-block mb-2">AI-powered analysis</small>
                    ${data.questions}
                </div>`;
            } else {
                // Basic questions
                let questionsHtml = '';
                data.questions.forEach((item, index) => {
                    if (typeof item === 'string') {
                        questionsHtml += `<p>${item}</p>`;
                    } else {
                        questionsHtml += `
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-title">Q: ${item.question}</h6>
                                <p class="card-text text-muted">Context: ${item.context}</p>
                            </div>
                        </div>`;
                    }
                });
                
                qaContainer.innerHTML = questionsHtml;
            }
        }
    });
</script>
{% endblock %}