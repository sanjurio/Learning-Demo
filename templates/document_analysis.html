{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row my-4">
        <div class="col-md-12">
            <h1>Document Analysis</h1>
            <p class="lead">Upload a document (PDF, DOCX, or TXT) to analyze its content using AI.</p>
        </div>
    </div>

    {% if not api_key_configured %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>OpenAI API Key Not Configured</strong>
        <p class="mb-0 mt-2">
            {% if current_user.is_admin %}
            The OpenAI API key is not configured. Please go to 
            <a href="{{ url_for('admin_api_keys') }}">API Keys</a> page to configure it.
            <br><br>
            <button id="test-connection-btn" class="btn btn-sm btn-info">Test API Connection</button>
            <div id="connection-test-results" class="mt-3 d-none">
                <h6>API Connection Test Results:</h6>
                <pre class="bg-dark text-light p-3 rounded" style="max-height: 200px; overflow-y: auto;"></pre>
            </div>
            {% else %}
            The OpenAI API key is not configured. Please contact an administrator to configure it.
            {% endif %}
        </p>
    </div>
    {% elif current_user.is_admin %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>OpenAI API Key Configured</strong>
        <p class="mb-0 mt-2">
            The OpenAI API key is configured. If you're experiencing issues with document analysis, 
            you can run a diagnostic test to check the connection.
            <br><br>
            <button id="test-connection-btn" class="btn btn-sm btn-info">Test API Connection</button>
            <div id="connection-test-results" class="mt-3 d-none">
                <h6>API Connection Test Results:</h6>
                <pre class="bg-dark text-light p-3 rounded" style="max-height: 200px; overflow-y: auto;"></pre>
            </div>
        </p>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Upload Document</h5>
                </div>
                <div class="card-body">
                    <form id="document-upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="document-file" class="form-label">Select Document</label>
                            <input type="file" class="form-control" id="document-file" name="file" accept=".pdf,.docx,.txt">
                            <div class="form-text">Supported formats: PDF, DOCX, TXT</div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="analyze-btn">
                            <span class="spinner-border spinner-border-sm d-none" id="loading-spinner" role="status" aria-hidden="true"></span>
                            Analyze Document
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">How It Works</h5>
                </div>
                <div class="card-body">
                    <p>
                        This tool uses AI to analyze documents and extract key information. 
                        Simply upload a document and the system will:
                    </p>
                    <ol>
                        <li>Extract the text content from your document</li>
                        <li>Generate a concise summary of the main points</li>
                        <li>Create a list of questions and answers based on the content</li>
                        <li>Provide key insights from the document</li>
                    </ol>
                    <p>
                        This can be useful for quickly understanding long documents, preparing for discussions, 
                        or creating study materials.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4 d-none" id="results-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Analysis Results</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>Document Summary</h6>
                        <div id="summary-content" class="p-3 bg-light rounded"></div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Questions & Answers</h6>
                        <div id="questions-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('document-upload-form');
    const fileInput = document.getElementById('document-file');
    const analyzeBtn = document.getElementById('analyze-btn');
    const loadingSpinner = document.getElementById('loading-spinner');
    const resultsCard = document.getElementById('results-card');
    const summaryContent = document.getElementById('summary-content');
    const questionsContent = document.getElementById('questions-content');
    
    // API connection test elements
    const testConnectionBtn = document.getElementById('test-connection-btn');
    const connectionTestResults = document.getElementById('connection-test-results');
    const connectionTestOutput = connectionTestResults ? connectionTestResults.querySelector('pre') : null;
    
    // Set up connection test if the button exists
    if (testConnectionBtn && connectionTestResults && connectionTestOutput) {
        testConnectionBtn.addEventListener('click', function() {
            // Show loading state
            testConnectionBtn.disabled = true;
            testConnectionBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';
            
            // Make API request to test connection
            fetch('/api/test-openai-connection')
                .then(response => response.json())
                .then(data => {
                    // Format the JSON response for display
                    connectionTestOutput.textContent = JSON.stringify(data, null, 2);
                    
                    // Show the results and color-code based on success/failure
                    connectionTestResults.classList.remove('d-none');
                    
                    if (data.success) {
                        connectionTestOutput.classList.add('text-success');
                        connectionTestOutput.classList.remove('text-danger');
                    } else {
                        connectionTestOutput.classList.add('text-danger');
                        connectionTestOutput.classList.remove('text-success');
                    }
                })
                .catch(error => {
                    // Show error
                    connectionTestResults.classList.remove('d-none');
                    connectionTestOutput.classList.add('text-danger');
                    connectionTestOutput.classList.remove('text-success');
                    connectionTestOutput.textContent = `Error running test: ${error.message}`;
                })
                .finally(() => {
                    // Reset button state
                    testConnectionBtn.disabled = false;
                    testConnectionBtn.textContent = 'Test API Connection';
                });
        });
    }
    
    // Document analysis form submission handler
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput.files.length) {
            alert('Please select a file to analyze');
            return;
        }
        
        // Show loading state
        loadingSpinner.classList.remove('d-none');
        analyzeBtn.disabled = true;
        resultsCard.classList.add('d-none');
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        
        fetch('/api/analyze-document', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            // First check if it's a valid JSON response
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || 'An error occurred while analyzing the document');
                    }
                    return data;
                });
            } else {
                // Not a JSON response, likely an HTML error page
                return response.text().then(text => {
                    console.error('Received non-JSON response:', text.substring(0, 200) + '...');
                    throw new Error('The server returned an invalid response. Please try again or contact an administrator.');
                });
            }
        })
        .then(data => {
            // Hide loading state
            loadingSpinner.classList.add('d-none');
            analyzeBtn.disabled = false;
            
            // Show results
            resultsCard.classList.remove('d-none');
            
            // Display summary
            summaryContent.textContent = data.summary || 'No summary generated';
            
            // Display questions
            questionsContent.innerHTML = '';
            if (data.questions && data.questions.length) {
                const accordion = document.createElement('div');
                accordion.className = 'accordion';
                accordion.id = 'questionsAccordion';
                
                data.questions.forEach((qa, index) => {
                    const itemId = `question-${index}`;
                    const collapseId = `collapse-${index}`;
                    
                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';
                    
                    accordionItem.innerHTML = `
                        <h2 class="accordion-header" id="${itemId}">
                            <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                                    aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="${collapseId}">
                                ${qa.question}
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                             aria-labelledby="${itemId}" data-bs-parent="#questionsAccordion">
                            <div class="accordion-body">
                                ${qa.answer}
                            </div>
                        </div>
                    `;
                    
                    accordion.appendChild(accordionItem);
                });
                
                questionsContent.appendChild(accordion);
            } else {
                questionsContent.innerHTML = '<p>No questions generated</p>';
            }
        })
        .catch(error => {
            // Hide loading state
            loadingSpinner.classList.add('d-none');
            analyzeBtn.disabled = false;
            
            // Show error in a nicer way
            resultsCard.classList.remove('d-none');
            summaryContent.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${error.message || 'An error occurred while analyzing the document'}
                </div>
                <div class="mt-3">
                    <p>Possible solutions:</p>
                    <ul>
                        <li>Make sure the OpenAI API key is configured correctly in the admin panel</li>
                        <li>Check that the file format is supported (PDF, DOCX, or TXT)</li>
                        <li>Try a different document if the problem persists</li>
                        <li>Contact an administrator for assistance</li>
                    </ul>
                </div>
            `;
            questionsContent.innerHTML = '';
        });
    });
});
</script>
{% endblock %}